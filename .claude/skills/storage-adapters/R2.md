# Cloudflare R2 Adapter Reference

Complete API reference for `@rytass/storages-adapter-r2`.

## Installation

```bash
npm install @rytass/storages @rytass/storages-adapter-r2
```

## Constructor & Configuration

### `StorageR2Service`

```typescript
import { StorageR2Service } from '@rytass/storages-adapter-r2';

const storage = new StorageR2Service(options: StorageR2Options);
```

### `StorageR2Options`

Configuration options for Cloudflare R2 storage adapter.

| Option | Type | Required | Description |
|--------|------|----------|-------------|
| `accessKey` | `string` | **Yes** | Cloudflare R2 access key ID |
| `secretKey` | `string` | **Yes** | Cloudflare R2 secret access key |
| `bucket` | `string` | **Yes** | R2 bucket name where files will be stored |
| `account` | `string` | **Yes** | Cloudflare account ID |
| `customDomain` | `string` | No | Custom domain for rewriting presigned URLs (e.g., `'https://cdn.example.com'`) |
| `converters` | `FileConverter<O>[]` | No | Array of file converters to process files before upload |
| `hashAlgorithm` | `'sha1' \| 'sha256'` | No | Hash algorithm for auto-generated filenames (default: `'sha256'`) |

**Example:**

```typescript
// Basic configuration
const storage = new StorageR2Service({
  accessKey: process.env.R2_ACCESS_KEY!,
  secretKey: process.env.R2_SECRET_KEY!,
  bucket: 'my-r2-bucket',
  account: process.env.R2_ACCOUNT_ID!,
});

// With custom domain for presigned URLs
const cdnStorage = new StorageR2Service({
  accessKey: process.env.R2_ACCESS_KEY!,
  secretKey: process.env.R2_SECRET_KEY!,
  bucket: 'my-r2-bucket',
  account: process.env.R2_ACCOUNT_ID!,
  customDomain: 'https://cdn.example.com',
});
```

## Methods

All standard methods (`write`, `batchWrite`, `read`, `remove`, `isExists`) are identical to [S3 adapter methods](S3.md#methods).

### `url(key, options?)`

Generate a presigned URL for temporary file access with optional custom expiration.

**Signature:**
```typescript
url(key: string, options?: PresignedURLOptions): Promise<string>
```

**Parameters:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `key` | `string` | File key (path) to generate URL for |
| `options` | `PresignedURLOptions` | Optional configuration |
| `options.expires` | `number` | Expiration time in **seconds** (not milliseconds) |

**Returns:** `Promise<string>` - Presigned URL (rewritten to custom domain if configured)

**Example:**

```typescript
// Default expiration (set by SDK)
const url1 = await storage.url('files/document.pdf');
console.log(url1);
// Without customDomain: https://my-r2-bucket.account-id.r2.cloudflarestorage.com/files/document.pdf?...
// With customDomain: https://cdn.example.com/files/document.pdf?...

// Custom expiration: 1 hour (3600 seconds)
const url2 = await storage.url('files/document.pdf', { expires: 3600 });

// Custom expiration: 7 days (604800 seconds)
const url3 = await storage.url('files/document.pdf', { expires: 604800 });
```

**Note:** If `customDomain` is configured in constructor, the presigned URL will be automatically rewritten to use your custom domain instead of the default R2 URL.

## Types

Same as [S3 adapter types](S3.md#types), plus:

### `PresignedURLOptions`

```typescript
interface PresignedURLOptions {
  expires?: number; // Expiration in seconds
}
```

Configuration for presigned URL generation:
- `expires`: Number of seconds until URL expires (not milliseconds like GCS)

## Complete Example

```typescript
import { StorageR2Service } from '@rytass/storages-adapter-r2';
import { StorageError, ErrorCode } from '@rytass/storages';
import { readFileSync } from 'fs';

async function main() {
  // 1. Initialize R2 storage with custom domain
  const storage = new StorageR2Service({
    accessKey: process.env.R2_ACCESS_KEY!,
    secretKey: process.env.R2_SECRET_KEY!,
    bucket: 'my-cdn-bucket',
    account: process.env.R2_ACCOUNT_ID!,
    customDomain: 'https://cdn.myapp.com',
  });

  try {
    // 2. Upload a file
    const assetBuffer = readFileSync('./logo.png');
    const uploadedFile = await storage.write(assetBuffer, {
      filename: 'assets/images/logo.png',
      contentType: 'image/png',
    });
    console.log('File uploaded:', uploadedFile.key);

    // 3. Generate presigned URL with default expiration
    const defaultUrl = await storage.url(uploadedFile.key);
    console.log('CDN URL:', defaultUrl);
    // Output: https://cdn.myapp.com/assets/images/logo.png?...

    // 4. Generate presigned URL with 1 hour expiration
    const shortUrl = await storage.url(uploadedFile.key, { expires: 3600 });
    console.log('1-hour URL:', shortUrl);

    // 5. Generate presigned URL with 30 days expiration
    const longUrl = await storage.url(uploadedFile.key, { expires: 2592000 });
    console.log('30-day URL:', longUrl);

    // 6. Download file
    const downloadedBuffer = await storage.read(uploadedFile.key, {
      format: 'buffer',
    });
    console.log('Downloaded size:', downloadedBuffer.length);

    // 7. Check existence
    const exists = await storage.isExists(uploadedFile.key);
    console.log('File exists:', exists); // true

    // 8. Batch upload static assets (auto-generated hash filenames)
    const assets = [
      readFileSync('./icon-1.svg'),
      readFileSync('./icon-2.svg'),
      readFileSync('./icon-3.svg'),
    ];

    // R2 batchWrite does NOT support options array
    const batchResults = await storage.batchWrite(assets);
    console.log('Batch uploaded:', batchResults.length, 'files');

    // For custom filenames, use write() in a loop:
    const customAssets = [
      { buffer: readFileSync('./icon-1.svg'), filename: 'assets/icons/icon-1.svg' },
      { buffer: readFileSync('./icon-2.svg'), filename: 'assets/icons/icon-2.svg' },
    ];
    await Promise.all(
      customAssets.map(a => storage.write(a.buffer, { filename: a.filename, contentType: 'image/svg+xml' }))
    );

    // 9. Delete old file
    await storage.remove('assets/old-logo.png');
    console.log('Old file deleted');
  } catch (error) {
    if (error instanceof StorageError) {
      console.error('Storage error:', error.code, error.message);
    } else {
      console.error('Unexpected error:', error);
    }
  }
}

main();
```

## Custom Domain Setup

To use custom domain with R2:

1. **Create R2 Bucket:**
   - Go to Cloudflare Dashboard
   - Navigate to R2
   - Create a new bucket

2. **Configure Custom Domain:**
   - Go to your R2 bucket settings
   - Navigate to "Custom Domains"
   - Add your custom domain (e.g., `cdn.example.com`)
   - Cloudflare will automatically configure DNS

3. **Use in Code:**

```typescript
const storage = new StorageR2Service({
  accessKey: 'your-r2-access-key',
  secretKey: 'your-r2-secret-key',
  bucket: 'my-bucket',
  account: 'your-account-id',
  customDomain: 'https://cdn.example.com', // Your configured domain
});

// Presigned URLs will automatically use custom domain
const url = await storage.url('file.pdf');
// Output: https://cdn.example.com/file.pdf?...
// Instead of: https://my-bucket.account-id.r2.cloudflarestorage.com/file.pdf?...
```

**Benefits of Custom Domain:**
- Branded URLs for your assets
- Better SEO
- Consistent branding across your application
- Can leverage Cloudflare CDN features

**Environment Variables:**

```bash
# .env
R2_ACCESS_KEY=your_r2_access_key
R2_SECRET_KEY=your_r2_secret_key
R2_ACCOUNT_ID=your_cloudflare_account_id
R2_BUCKET=my-r2-bucket
R2_CUSTOM_DOMAIN=https://cdn.example.com
```
